create table THUYNTB.APP_3B_202309
AS
with APP_3B AS(
SELECT B.SUBSCRIBER_ID,B.LOAI_SIM,B.GOI_KMCB_SU_DUNG,B.SERVICE_ID,B.TIME_END, '84'||SUBSCRIBER_ID AS SUBSCRIBER_ID_84
FROM VINATT.TIEUDUNG_BTS_202309_KIEUMOI B  -----------SỬA CÁI THÁNG ĐÊ--------
),
locfan as(
SELECT *
FROM
    (
    SELECT A.*, ROW_NUMBER() OVER(PARTITION BY ACCS_MTHD_KEY ORDER BY A.HNDST_BRND_CD, A.HNDST_MDL_TYP_CD) RA 
    FROM CUOCVINA.HCM_KPI_VINAPHONE_202309 A  ------------sửa cái tháng luôn đê-----------------------
    )
WHERE RA = 1
),
tonghop as(
select SUBSCRIBER_ID, round(sum(to_number(TOTAL_TKC))/3, 3) as avg_tkc
from(
    SELECT B.SUBSCRIBER_ID, B.TOTAL_TKC FROM VINATT.TIEUDUNG_BTS_202309_KIEUMOI B --DOI SO GIUM
    WHERE B.SUBSCRIBER_ID IN (SELECT A.SUBSCRIBER_ID FROM THUYNTB.APP_3B A) --DOI SO GIUM
    UNION ALL
    SELECT C.SUBSCRIBER_ID, C.TOTAL_TKC FROM VINATT.TIEUDUNG_BTS_202307_KIEUMOI C --DOI SO GIUM
    WHERE C.SUBSCRIBER_ID IN (SELECT A.SUBSCRIBER_ID FROM THUYNTB.APP_3B A) --DOI SO GIUM
    UNION ALL
    SELECT D.SUBSCRIBER_ID, D.TOTAL_TKC FROM VINATT.TIEUDUNG_BTS_202308_KIEUMOI D --DOI SO GIUM
    WHERE D.SUBSCRIBER_ID IN (SELECT A.SUBSCRIBER_ID FROM THUYNTB.APP_3B A) --DOI SO GIUM
    )
group by SUBSCRIBER_ID
),
LOCFAN2 AS(
select B.SUBSCRIBER_ID from VINATT.TIEUDUNG_BTS_202309_KIEUMOI b  --- DOI SO LUON NHA BA
where to_number(tkc_data) = 0 
    and to_number(DATA_USG) = 0 
    and to_number(DATA_BLLD_USG) = 0  
    and to_number(TOT_DATA_DISC_AMT) = 0 
    and to_number(TOT_DATA_PAYG_RVN_AMT) = 0  
    and SERVICE_ID is null
)
SELECT A.SUBSCRIBER_ID, B.HNDST_BRND_CD,B.HNDST_MDL_TYP_CD, A.LOAI_SIM, A.GOI_KMCB_SU_DUNG AS GOICUOC_CHINH, A.SERVICE_ID AS GOICUOC_DATA_THEM, 
    CASE WHEN D.SUBSCRIBER_ID IS NOT NULL THEN 1 
         ELSE NULL END NONDATA,
    A.TIME_END, C.AVG_TKC AS TKC_AVG, A.SUBSCRIBER_ID_84
FROM APP_3B A LEFT JOIN LOCFAN B ON B.ACCS_MTHD_KEY = A.SUBSCRIBER_ID_84 AND B.LOAI_TB=1
    LEFT JOIN TONGHOP C ON C.SUBSCRIBER_ID = A.SUBSCRIBER_ID
    LEFT JOIN LOCFAN2 D ON D.SUBSCRIBER_ID = A.SUBSCRIBER_ID
;
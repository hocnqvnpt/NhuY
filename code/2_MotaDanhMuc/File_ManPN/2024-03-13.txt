select * from vinatt.TIEUDUNG_BTS_202308_KIEUMOI
WHERE SUBSCRIBER_ID = '941033040'

delete from KHAC_PHAN_RA;
SELECT * FROM nganbh.IMPORT_CHITUNG;

select * from KHAC_PHAN_RA2
as select ACTIVE_DATE, COS_NAME, ACC_ALO, ACC_NAME, KPI_NAME, CURRENT_STATE, PROVINCE_PSC, BTS_NAME, ACCOUNT_DK, NGAY_THAOTAC, RESELLER_CONTACT_NAME, PHONG_BAN_HANG, SUBSCRIBER_AGE, SERVICE_CODE_T_4, SERVICE_CODE_T_5, SERVICE_CODE_T_1, SERVICE_CODE_T_2, SERVICE_CODE_T_3, TKC_T_1, TKC_T_2, TKC_T_3, TKC_T_4, TKC_T_5, TKC_T_6, cast(null as varchar2(555)) as sub_kpi_name, THANG from KHAC_PHAN_RA
;
create table KHAC_PHAN_RA
as
select cast(null as varchar2(444)) as PROVINCE_INIT, cast(null as varchar2(444)) as SUBSCRIBER_ID ,a.* from KHAC_PHAN_RA2 a
where 1 =0;

rollback;

where thang = 2024031;

create table;

update KHAC_PHAN_RA
set thang = 2024031
where thang is null;
alter table KHAC_PHAN_RA drop column loai_tb;
update KHAC_PHAN_RA
set thang = 2024021
where thang is null;
COMMIT;

SELECT * FROM KHAC_PHAN_RA a LEFT JOIN khac_kenh_noibo F ON A.ACCOUNT_DK = F.SO_ELOAD
where F.SO_ELOAD is not null
GROUP BY SUBSCRIBER_ID;

with duynhat as(
select * 
from 
    (
    select SUBSCRIBER_ID, row_number() over(partition by SUBSCRIBER_ID order by SUBSCRIBER_ID) ra 
    from manpn.KHAC_PHAN_RA@vinadata a
    where thang = 2024031
    )
where ra = 1
),
phanloaiTKC as(
SELECT A.SUBSCRIBER_ID, MAIN_ACCT_BAL_AMT, b.pbhkv
FROM duynhat A LEFT JOIN thuyntb.tieudung_bts_202402_kieumoi_t@vinadata B ON A.SUBSCRIBER_ID = B.SUBSCRIBER_ID 
WHERE B.SUBSCRIBER_ID IS NOT NULL -----------------------------TIME VÀ BẢNG
--KIEM TRA XEM TIEU DUNG CO TRUNG LAP SUBSCRIBER_ID KHONG?
--WHERE TO_NUMBER(REPLACE(B.TOTAL_TKC, '.', ',')) != 0 --B.SUBSCRIBER_ID IS NULL OR TO_NUMBER(REPLACE(B.TOTAL_TKC, '.', ',')) = 0
),
DS_CHUANHOA AS(
SELECT A.SDT, B.MSISDN, SUBSTR(SDT, 3) AS SUBSCRIBER_ID
FROM (SELECT '84'||SUBSCRIBER_ID AS SDT FROM duynhat) A LEFT JOIN nganbh.IMPORT_CHITUNG@vinadata B ON A.SDT = B.MSISDN -- sửa tháng
WHERE B.MSISDN IS NOT NULL
),
on_db as(
select b.*, TO_CHAR(SO_ELOAD) ELOAD from(
select a.*, row_number() over(partition by SO_ELOAD order by user_ccbs) ra
from manpn.DS_DIEMBAN@vinadata a
WHERE THANG = 2024023
) b
where ra = 1
),
kenh_noibo as(
select b.*, TO_CHAR(ELOAD_NUMBER) ELOAD from(
select a.*, row_number() over(partition by eload_number order by user_ccbs) ra
from manpn.danh_sach_diem_ban@vinadata a
) b
where ra = 1
)
SELECT A.*, CASE WHEN B.SUBSCRIBER_ID IS NOT NULL THEN 'Có' ELSE 'Không' END PSC_202402,
    b.pbhkv as phong_psc202402,
    CASE WHEN C.SUBSCRIBER_ID IS NOT NULL THEN 'Có trong DS chuẩn hóa' ELSE 'Không trong DS chuẩn hóa' END PHANLOAI_CHUANHOA,
    CASE WHEN D.ELOAD IS NOT NULL THEN 'Kênh ngoài' 
         WHEN F.SO_ELOAD IS NOT NULL THEN 'Kênh nội bộ' 
         WHEN G.USER_CCBS IS NOT NULL THEN  'User nội bộ mở' 
         ELSE 'Không xác định' END LOAI_KENH,
    CASE WHEN F.SO_ELOAD IS NOT NULL THEN F.TEN
         WHEN G.USER_CCBS IS NOT NULL THEN G.TEN_TO
         ELSE '' END TEN_TO,
    CASE WHEN F.SO_ELOAD IS NOT NULL THEN F.TEN_KENH_CHA
         WHEN G.USER_CCBS IS NOT NULL THEN G.TEN_PB
         ELSE '' END TEN_PHONGBAN,
    CASE WHEN MAIN_ACCT_BAL_AMT IS NULL THEN 'Không xác định' ELSE MAIN_ACCT_BAL_AMT END SO_DU_TKC, -- đổi cái tên cột
    --case when a.SUBSCRIBER_ID in (select SUBSCRIBER_ID from manpn.KHAC_PHAN_RA@vinadata where thang = 2024031) then 'Có khóa cứng' 
    --     else 'Không khóa cứng' end TAP_KHOA_CUNG
    SUB_KPI_NAME as TAP_KHOA_CUNG
FROM manpn.KHAC_PHAN_RA@vinadata A LEFT JOIN phanloaiTKC B ON A.SUBSCRIBER_ID = B.SUBSCRIBER_ID
    LEFT JOIN DS_CHUANHOA C ON A.SUBSCRIBER_ID = C.SUBSCRIBER_ID
    LEFT JOIN on_db D ON A.ACCOUNT_DK = D.ELOAD
    LEFT JOIN ttkd_bsc.nhanvien_202402 E on D.user_ccbs = E.user_ccbs -- đổi bảng nhân viên
    LEFT JOIN manpn.khac_kenh_noibo@vinadata F ON A.ACCOUNT_DK = F.SO_ELOAD
    LEFT JOIN ttkd_bsc.nhanvien_202402 G ON A.ACCOUNT_DK = G.USER_CCBS --đổi bảng nhân viên
WHERE A.THANG = 2024031;

select * from manpn.khac_kenh_noibo@vinadata ;

select * from ttkd_bsc.nhanvien_202402;
select * from manpn.KHAC_PHAN_RA@vinadata;
select * from nganbh.IMPORT_CHITUNG@vinadata;
select * from khac_kenh_noibo;
select * from manpn.khac_kenh_noibo@vinadata;
select * from(
select a.*, row_number() over(partition by eload_number order by user_ccbs) ra
from danh_sach_diem_ban a
)
where ra = 1

select * from ttkd_bsc.nhanvien_202402@dhsxkd
select * from danh_sach_diem_ban
order by user_ccbs
group by eload_number
where eload_number = 84918520959
;
941033040
818327784
912444584

select * from khac_kenh_noibo

select * from ttkd_bsc.nhanvien_202308@dhsxkd;

with on_db as(
select b.*, TO_CHAR(ELOAD_NUMBER) ELOAD from(
select a.*, row_number() over(partition by eload_number order by user_ccbs) ra
from danh_sach_diem_ban a
) b
where ra = 1
)
SELECT A.ACCOUNT_DK, b.user_ccbs
FROM KHAC_PHAN_RA A LEFT JOIN on_db B 
        ON A.ACCOUNT_DK = B.ELOAD
    LEFT JOIN ttkd_bsc.nhanvien_202308@dhsxkd d on b.user_ccbs = d.user_ccbs
WHERE ELOAD IS NOT NULL and b.user_ccbs is not null;
 